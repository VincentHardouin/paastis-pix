# 2022-09-17 - Gal√®re

Je gal√®re depuis 3 jours avec le registre en mode Redis.

Je me tape plein d'erreurs incompr√©hensibles.

```
TypeError: Invalid argument type
    at encodeCommand (/Users/jeremy.buget/Works/paastis/paastis-engine/node_modules/@redis/client/dist/lib/client/RESP2/encoder.js:17:19)
    at RedisCommandsQueue.getCommandToSend (/Users/jeremy.buget/Works/paastis/paastis-engine/node_modules/@redis/client/dist/lib/client/commands-queue.js:187:45)
    at Commander._RedisClient_tick (/Users/jeremy.buget/Works/paastis/paastis-engine/node_modules/@redis/client/dist/lib/client/index.js:440:76)
    at Commander._RedisClient_sendCommand (/Users/jeremy.buget/Works/paastis/paastis-engine/node_modules/@redis/client/dist/lib/client/index.js:424:82)
    at Commander.commandsExecutor (/Users/jeremy.buget/Works/paastis/paastis-engine/node_modules/@redis/client/dist/lib/client/index.js:170:154)
    at Commander.BaseClass.<computed> [as get] (/Users/jeremy.buget/Works/paastis/paastis-engine/node_modules/@redis/client/dist/lib/commander.js:8:29)
    at file:///Users/jeremy.buget/Works/paastis/paastis-engine/registry/RunningAppRegistryStore.js:100:48
    at Array.reduce (<anonymous>)
    at RedisRunningAppRegistryStore.all (file:///Users/jeremy.buget/Works/paastis/paastis-engine/registry/RunningAppRegistryStore.js:99:38)
    at processTicksAndRejections (node:internal/process/task_queues:96:5)
```

Elles surviennent quand je tente de faire `_redisClient.keys('*')` dans le code.

‚úÖ Quand je r√©veille une ou plusieurs apps, elles sont bien ajout√©es dans Redis.

```shell
# c√¥t√© shell
$ curl -v localhost:3000 -H "Host: hellofastifydeux.proxy.paastis.dev"

# c√¥t√© Redis
> keys *
1) "hello-fastify"
2) "hellofastifydeux"
```

‚úÖ Et elles suppriment bien au moment, ni trop t√¥t, ni trop tard.


‚ùå J'ai tent√© d'am√©liorer les modules de type singleton : `./redis.js`, `registry/index.js`, etc.

‚ùå J'en suis √† me demander si le probl√®me ne vient pas de la cl√©, avec des `-`, ex : `hello-fastify-2`.
Mais d'apr√®s [la doc sur les cl√©s](https://redis.io/docs/data-types/tutorial/#keys), c'est ok.

‚ùå J'ai tent√© de passer par les commandes `HGETALL` et `MGET` mais elles ne font pas vraiment ce que je veux et √ßa ne marche pas mieux.

‚ùå J'en suis venu √† soup√ßonner WebStorm.
Ou le "mode debug" de l'IDE.
Mais j'obtiens les m√™mes soucis dans le terminal.

‚ùå J'ai regard√© [les issues de `node-redis`](https://github.com/redis/node-redis/issues?q=is%3Aissue+is%3Aopen+Invalid+argument+type).

‚ùå J'ai modifi√© le `docker-compose` pour pr√©ciser qu'on utilise la derni√®re version de l'image Docker pour Redis `redis:latest`.

‚ùå J'ai foutu des `await` le plus que je pouvais suspectant un probl√®me de chargement des modules ESM.

‚ùå J'ai essay√© en n'utilisant que des apps Scalingo sans tiret (renommer `hello-fastify-2` en `hellofastifydeux`).

‚ùå J'ai tent√© de red√©marrer la stack `docker-compose down --remove-orphans` et de supprimer le volume `cache:/data`.

‚ùå J'ai tent√© de passer par les attributs de classe priv√©s en JS (`this.#_redisClient.keys('*')`).

‚ùå J'ai tent√© de d√©marrer le client Redis dans le d√©marrage du serveur plut√¥t que dans le module `./redis.js`.

‚ùå Je me suis demand√© si ce n'est pas li√© de vouloir faire tourner dans un m√™me programme Node un serveur HTTP et un CRON.

ü§î L'appli crash au moment du tick du CRON.
Je mets un try catch sur la fonction `./server.js#stopIdleApps`
√Ä d√©faut de trouver la source de l'erreur, j'aimerais bien que le programme ne plante pas.
‚ùå Le programme continue de tomber ?!?

**J'ai tent√© l'option `legacyMode`** lors de la cr√©ation du client Redis.
```javascript
client = createClient({
url: config.registry.redisUrl,
legacyMode: true
});
```

J'obtiens une erreur au d√©marrage :
```shell
Server is running on https://localhost:3000
SyntaxError: Unexpected token u in JSON at position 0
    at JSON.parse (<anonymous>)
    at RedisRunningAppRegistryStore.get (file:///Users/jeremy.buget/Works/paastis/paastis-engine/registry/RunningAppRegistryStore.js:84:17)
    at processTicksAndRejections (node:internal/process/task_queues:96:5)
    at async RunningAppRegistry.getApp (file:///Users/jeremy.buget/Works/paastis/paastis-engine/registry/RunningAppRegistry.js:17:18)
    at async stopIdleApps (file:///Users/jeremy.buget/Works/paastis/paastis-engine/server.js:55:28)
    at async startCron (file:///Users/jeremy.buget/Works/paastis/paastis-engine/server.js:81:3)
```
‚úÖ Au moins le programme n'est pas crash√©.
Je red√©marre Redis depuis Docker.
Peut-√™tre que le format des cl√©s existantes n'est plus appropri√©.
M√™me erreur.

Je change l'impl√©mentation pour tenir compte de l'existence de la donn√©e renvoy√©e.
```javascript
    const data = await this.#_redisClient.get(appName);
    if (data) {
      return JSON.parse(data);
    }
```
√áa plante un peu plus loin, non plus sur `RedisRunningAppRegistryStore#get` mais sur `RedisRunningAppRegistryStore#all`.
On fait le m√™me changement.
‚úÖ Le programme se lance sans crasher.
‚ùå Mais le r√©sultat de `/system/apps` est toujours tableau vide. 
Je mets un point d'arr√™t.

ü§î C'est bizarre :
- dans Redis : je vois mes 2 cl√©s/entr√©es
- dans WebStorm : `const keys = await this.#_redisClient.keys('*')` (le r√©sultat) vaut `undefined`.
Je me demande si le client Redis est toujours connect√©.
Et si oui, si c'est √† la bonne base.

üí° J'utilise la commande Redis `CLIENT LIST` qui permet de voir les clients connect√©s au serveur.
Je vois bien mes 2 clients :
- le conteneur Docker
- l'appli Node


## Redis

#### Acc√©der au Redis CLI via Docker 

```shell
$ docker exec -it paastis-registry redis-cli
```

#### Suivre les commandes ex√©cut√©es sur Redis en temps r√©el

```shell
127.0.0.1:6379> MONITOR
```
